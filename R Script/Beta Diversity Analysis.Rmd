---
title: "Beta Diversity"
author: "Jessica Wang"
date: "2025-11-24"
output: html_document
---

## Load Libraries
```{r}
library(phyloseq)
library(vegan)
library(dplyr)
library(ggplot2)
library(ANCOMBC)
library(tidyverse)

ps <- readRDS("../Datasets/ps_alldoses.rds")

ps1 <- readRDS("../Datasets/ps_dose1.rds")

ps2 <- readRDS("../Datasets/ps_dose4.rds")

```

## Compute Weighted Unifrac for 1-dose
```{r}
set.seed(123)
wu_dist <- distance(ps1, method = "unifrac", weighted = TRUE)

ord_nmds <- ordinate(ps1, method = "NMDS", distance = wu_dist, trymax = 100)

p1_nmds <- plot_ordination(ps1, ord_nmds, color = "Response",
                          shape = "Vaccination.status") +
  geom_point(size = 3, alpha = 0.9) +
  theme_classic() +
  labs(
    title = "Weighted UniFrac NMDS",
    color = "Humoral response",
    shape = "Vaccination status")

p1_nmds
```
## Compute Weighted Unifrac for 4-dose
```{r}
set.seed(123)
wu_dist2 <- distance(ps2, method = "unifrac", weighted = TRUE)

ord_nmds2 <- ordinate(ps2, method = "NMDS", distance = wu_dist2, trymax = 100)

p2_nmds <- plot_ordination(ps2, ord_nmds2, color = "Response",
                          shape = "Vaccination.status") +
  geom_point(size = 3, alpha = 0.9) +
  theme_classic() +
  labs(
    title = "Weighted UniFrac NMDS",
    color = "Humoral response",
    shape = "Vaccination status")

p2_nmds
```
## Compute Bray Curtis for 1-dose
```{r}
bray1 <- distance(ps1, method = "bray")
ord_bray1 <- ordinate(ps1, "NMDS", distance = bray1)
plot_ordination(ps1, ord_bray1, color = "Response")

```
## Compute Bray Curtis for 4-dose
```{r}
bray2 <- distance(ps2, method = "bray")
ord_bray2 <- ordinate(ps2, "NMDS", distance = bray2)
plot_ordination(ps2, ord_bray2, color = "Response")
```
## Perform pairwise PERMANOVA on weighted unifrac (for both 1 and 4 dose)
```{r PERMANOVA}
unifrac_weighted <- distance(ps, method = "unifrac", weighted = TRUE)

meta <- as.data.frame(as(sample_data(ps), "data.frame"))
meta$Vaccination.Status <- factor(meta$Vaccination.Status)
meta$Response <- factor(meta$Response)

dist_mat <- as.matrix(unifrac_weighted)

pairwise_perm <- list()

for (resp in levels(meta$Response)) {
  idx <- which(meta$Response == resp)
  if (length(idx) < 2) next
  if (length(unique(meta$Vaccination.Status[idx])) < 2) next
  
  sub_dist <- as.dist(dist_mat[idx, idx])
  sub_meta <- as.data.frame(meta[idx, , drop = FALSE])
  
  pairwise_perm[[resp]] <- adonis2(
    sub_dist ~ Vaccination.Status,
    data = sub_meta,
    permutations = 999
  )
}

pairwise_perm

```

